# Ejercicio 6

> Realiza los módulos de programación necesarios para evitar que un mismo propietario envíe dos caballos a una misma carrera.

CREATE OR REPLACE TRIGGER no_dos_caballos
BEFORE INSERT ON participaciones
FOR EACH ROW
declare
begin
if 'Dueño'
end if;
end;
/



---CREO EL PAQUETE QUE VA A ALBERGAR EL CASCARÓN DE LA TABLA

CREATE OR REPLACE PACKAGE CONTROLPROPIETARIOS
AS
V_CODCABALLO NUMBER;
TYPE tREGISTROTABLACABALLOS IS RECORD
(
CODIGODNI CABALLOS.DNIPROPIETARIO%type
CODIGOCARRERA PARTICIPACIONES.CODIGOCARRERA%type
);
TYPE tTABLACONTROLDNI IS TABLE OF tREGISTRODNI
INDEX BY BINARY_INTEGER;
CONTAR tTABLACONTROLDNI;
END CONTROLPROPIETARIOS;
/

--PROCEDO A LLENAR ESAS TABLAS CARGADAS EN MEMORIA PARA CONSULTARLAS LUEGO

CREATE OR REPLACE TRIGGER RELLENARVARIABLESDNI
BEFORE INSERT OR UPDATE ON PARTICIPACIONES
DECLARE
CURSOR C_BUSCAR IS select CODIGOCARRERA,DNIPROPIETARIO into  from PARTICIPACIONES P,CABALLOS C WHERE C.CODIGOCABALLO=P.CODIGOCABALLO;
INDICE NUMBER:=0;
BEGIN
FOR V_BUSCAR IN C_BUSCAR LOOP
    CONTROLPROPIETARIOS.CONTAR(INDICE).CODIGODNI := V_BUSCAR.DNIPROPIETARIO;
    CONTROLPROPIETARIOS.CONTAR(INDICE).CODIGOCARRERA := V_BUSCAR.CODIGOCARRERA;
    INDICE:=INDICE+1;
END LOOP;
END RELLENARVARIABLESDNI;
/

CREATE OR REPLACE TRIGGER CONTROLARCABALLOS
BEFORE INSERT OR UPDATE ON PARTICIPACIONES
FOR EACH ROW
DECLARE
V_CODCABALLO NUMBER;
BEGIN
select CODCABALLO into V_CODCABALLO from caballos where propietario = :new.dnipropietario
IF EXISTECARRERADNI(:NEW.DNIPROPIETARIO,:NEW.CODCARRERA) = 1 THEN
    RAISE_APPLICATION_ERROR(20002'No puedes meter más de un caballo por propietario');
END CONTROLARCABALLOS;
/

CREATE OR REPLACE FUNCTION EXISTECARRERADNI (p_dni CABALLOS.DNIPROPIETARIO%type, p_carrera CODIGOCARRERA PARTICIPACIONES.CODIGOCARRERA%type)
return number
v_existe := 0
IS
BEGIN
for i in CONTROLPROPIETARIOS.CONTAR.FIRST .. CONTROLPROPIETARIOS.CONTAR.LAST LOOP
        if CONTROLPROPIETARIOS.CONTAR(i).CODIGODNI == p_dni and CONTROLPROPIETARIOS.CONTAR(i).CODIGOCARRERA == p_carrera THEN
            v_existe:=1;
END LOOP;
END;
return v_existe;
/





select CODIGOCARRERA,DNIPROPIETARIO from PARTICIPACIONES P,CABALLOS C WHERE C.CODIGOCABALLO=P.CODIGOCABALLO;